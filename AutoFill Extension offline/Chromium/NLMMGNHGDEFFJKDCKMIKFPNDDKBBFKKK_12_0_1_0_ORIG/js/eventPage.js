/*!
 * @package Autofill
 * @author T. H. Doan
 * @copyright (c) 2010-2023
 * @link https://www.tohodo.com/
 */
var e,t,r=chrome.runtime.getManifest(),o=["http://*/*","https://*/*","file://*/*"],a=r.name,n="Backup - ",c="cm_execute",s="cm_textclips",i={},l={},u={},d={};function m(e,t){!t&&performance.now()-u[e]<1500||(chrome.browserAction.setBadgeText({tabId:e,text:""},(function(){chrome.runtime.lastError})),i={},l={},d={})}function h(e){return new Promise((function(t,r){chrome.storage.local.set(e,(function(){var e=chrome.runtime.lastError;e?(console.error("["+a+"] "+e.message),r(e.message)):t()}))}))}function f(e,t){var r=["all"];chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:"cm_add_one",contexts:["editable"],title:chrome.i18n.getMessage("generalAddRule")}),chrome.contextMenus.create({id:"cm_add_all",contexts:r,title:chrome.i18n.getMessage("generalAddRules")}),chrome.contextMenus.create({id:c,contexts:r,title:chrome.i18n.getMessage("generalExecute")}),chrome.contextMenus.create({id:c+"_1",parentId:c,contexts:r,type:"radio",title:chrome.i18n.getMessage("optionsProfilesMenuAll"),checked:1===t}),chrome.contextMenus.create({id:c+"_2",parentId:c,contexts:r,type:"radio",title:chrome.i18n.getMessage("optionsProfilesMenuUnfiled"),checked:2===t});for(var o=0;o<e.length;++o)0!==e[o].n.indexOf(n)&&chrome.contextMenus.create({id:c+"_"+(o+5),parentId:c,contexts:r,type:"radio",title:e[o].n+(e[o].h?" ("+e[o].h+")":""),checked:t===o+5});chrome.contextMenus.create({id:s,contexts:["editable"],title:chrome.i18n.getMessage("generalInsert")}),chrome.storage.local.get("textclips",(function(e){if(!chrome.runtime.lastError){var t=e.textclips;if(t.length)for(var r,o,a,n=[],c=0;c<t.length;++c){r=t[c].trim().split("\n")[0].split(/ *> */),o=a=s;for(var i=0;i<r.length;++i)o+="_"+r[i].replace(/\W/g,"_").toLowerCase(),n.indexOf(o)<0&&(chrome.contextMenus.create({id:o,parentId:a,contexts:["editable"],title:r[i]},(function(){chrome.runtime.lastError})),n.push(o)),a=o}else chrome.contextMenus.remove(s,(function(){chrome.runtime.lastError}))}})),chrome.contextMenus.create({id:"cm_separator",contexts:r,type:"separator"}),chrome.contextMenus.create({id:"cm_options",contexts:["page","frame","selection","link","editable","image","video","audio"],title:chrome.i18n.getMessage("generalOptions")})}function g(e){chrome.contextMenus.update(c+"_"+e,{checked:!0})}function p(e,t,r,o){void 0!==t&&t.id||(t=e),chrome.browserAction.getTitle({tabId:t.id},(function(a){a.indexOf(chrome.i18n.getMessage("generalNoFields"))>-1||chrome.tabs.sendMessage(t.id,{type:"showWizard",data:{editable:e.editable&&!!r,frame:!!e.frameId,type:o}},(function(e){chrome.runtime.lastError||e&&!e.open&&(e.css||chrome.tabs.insertCSS(t.id,{file:"css/wizard.css"}),chrome.tabs.executeScript(t.id,{file:"js/wizard.js"}))}))}))}function b(t,r,o){var n=t.data;switch(t.type){case"buildMenu":return void f(n.cats,n.catnow);case"clearHighlight":return void chrome.tabs.sendMessage(r.tab.id,{type:"clearHighlight"});case"executeRules":m(r.tab.id),h({catnow:n.catnow}).then((function(){chrome.storage.local.get(["other"],(function(e){e.other.menu&&g(n.catnow)})),chrome.tabs.sendMessage(r.tab.id,{type:"autofill",catnow:n.catnow}),o({})}));break;case"injectJquery":chrome.tabs.executeScript(r.tab.id,{file:"js/jquery3.min.js"},(function(){chrome.runtime.lastError||o({})}));break;case"openOptions":return void chrome.runtime.openOptionsPage();case"resetCounters":return void m(r.tab.id,n.force);case"saveCat":chrome.storage.local.get(["catcount","catnow","cats","other"],(function(e){if(!chrome.runtime.lastError){var t="c"+e.catcount++;if(e.cats.push({k:t,n:n.cat.n,s:n.cat.s||""}),!n.backup){for(var r=0;r<e.cats.length;++r)if(e.cats[r].n===n.cat.n){e.catnow=r+5;break}e.other.menu&&f(e.cats,e.catnow)}h(e).then((function(){o({catnow:e.catnow,cat:t})}))}}));break;case"saveRules":return void chrome.storage.local.get(["catnow","cats","o","other","rulecount","rules"],(function(e){if(!chrome.runtime.lastError){for(var t,r,o=n.rules[0].c,a="",c=[],s=JSON.parse(e.rules),i=0,l=e.cats.length;i<l;++i){if(e.cats[i].k===o){t=i,n.backup||(e.catnow=t+5);break}i===l-1&&(o="",e.catnow=2)}e.cats[t]&&(a=e.cats[t].s)&&c.push(a),e.other.menu&&!n.backup&&g(e.catnow),r=Object.keys(s).filter((function(e){return s[e].c===o}));var u,d,m,f;for(i=0;i<n.rules.length;++i){u=n.rules[i].n,(m=n.rules[i].s)&&c.indexOf(m)<0&&c.push(m),f=!0;for(var p=0;p<r.length;++p)0===i&&s[r[p]].s&&c.indexOf(s[r[p]].s)<0&&c.push(s[r[p]].s),n.rules[i].t!==s[r[p]].t||u!==s[r[p]].n.replace(/\/\*.*?\*\/\s*/g,"")||m!==s[r[p]].s&&m!==a||(s[r[p]].v=n.rules[i].v,f=!1);f&&(d="r"+e.rulecount++,s[d]={t:n.rules[i].t,n:u,v:n.rules[i].v,s:m,o:n.backup?0:e.other.overwrite,c:o},r.push(d),++e.o.k)}if(e.cats[t]){for(i=0;i<r.length;++i)s[r[i]].s=c.length>1?s[r[i]].s||a:"";e.cats[t].s=c.length>1?"":a||c[0]}e.rules=JSON.stringify(s),h(e)}}));case"updateCatMenu":return void g(n.catnow);case"updateStatus":return void 0===i[r.tab.id]&&(i[r.tab.id]=0),void 0===l[r.tab.id]&&(l[r.tab.id]=0),void 0===d[r.tab.id]&&(d[r.tab.id]=-1),i[r.tab.id]+=n.fields,l[r.tab.id]+=n.filled,-1===d[r.tab.id]&&(i[r.tab.id]?(++d[r.tab.id],chrome.browserAction.setIcon({tabId:r.tab.id,path:{16:"images/icon16.png",24:"images/icon24.png",32:"images/icon32.png"}}),chrome.browserAction.setTitle({tabId:r.tab.id,title:a})):chrome.browserAction.setTitle({tabId:r.tab.id,title:a+"\n"+chrome.i18n.getMessage("generalNoFields")})),void(l[r.tab.id]&&chrome.storage.local.get(["o","other"],(function(e){if(!chrome.runtime.lastError){if(e.other.badge&&chrome.browserAction.setBadgeText({tabId:r.tab.id,text:(l[r.tab.id]||"")+""}),0===d[r.tab.id]&&e.other.sound)++d[r.tab.id],new Audio(chrome.runtime.getURL("sounds/sound.ogg")).play();clearTimeout(d.i),d.i=setTimeout((function(e){var t=e.o;t.i+=e.n,h({o:t})}),2e3,{n:l[r.tab.id]||0,o:e.o}),u[r.tab.id]=performance.now()}})));case"appendRules":return void(e=e.concat(n));case"gatherRules":return e=[],void chrome.tabs.sendMessage(r.tab.id,{type:"create",cat:n},x)}return!0}function v(){t=void 0}function x(r){setTimeout((function(){var o;o={type:"gotRules",data:e,field:r.field},t&&t.postMessage(o)}),100)}chrome.browserAction.onClicked.addListener(p),chrome.commands.onCommand.addListener((function(e,t){if("execute_all_profiles"===e){m(t.id),h({catnow:1}).then((function(){chrome.storage.local.get(["other"],(function(e){e.other.menu&&g(1)})),chrome.tabs.sendMessage(t.id,{type:"autofill",catnow:1})}))}})),chrome.contextMenus.onClicked.addListener((function(e,t){if("cm_options"===e.menuItemId)chrome.runtime.openOptionsPage();else if(e.menuItemId.indexOf("add")>-1)p(e,t,e.menuItemId.indexOf("one")>-1,"gen");else if(e.parentMenuItemId===c){var r=+e.menuItemId.slice((c+"_").length);m(),h({catnow:r}).then((function(){chrome.tabs.sendMessage(t.id,{type:"autofill",catnow:r})}))}else 0===e.menuItemId.indexOf(s)&&chrome.tabs.sendMessage(t.id,{type:"insertText",id:e.menuItemId.replace(s+"_","")})})),chrome.runtime.onConnect.addListener((function(e){if("wizard"===e.name)t=e,e.onDisconnect.addListener(v),e.onMessage.addListener(b)})),chrome.runtime.onInstalled.addListener((function(e){chrome.storage.local.get({ver:r.version,catcount:1,catnow:2,cats:[],rulecount:1,rules:"{}",advanced:[],exceptions:[],textclips:[],variables:[],e:"",o:{i:0,k:0},other:{activecat:1,attributesoff:0,autoimport:0,backup:0,badge:1,closeinfobar:1,debug:0,delay:0,filtercats:0,fluid:1,hidebackup:0,manual:0,mask:1,menu:1,overwrite:1,sitefilters:1,skiphidden:0,sound:0,vars:1,voice:0},attributesoff:"",autoimport:"",backup:30,closeinfobar:1,delay:.5,sitefilters:0,voice:1},(function(e){h(e),e.other.menu&&f(e.cats,e.catnow)}))})),chrome.runtime.onMessage.addListener(b),chrome.runtime.onStartup.addListener((function(){chrome.storage.local.get(["autoimport","catnow","cats","other"],(function(e){e.other.menu&&f(e.cats,e.catnow),!chrome.runtime.lastError&&e.other.autoimport&&e.autoimport&&fetch(e.autoimport,{cache:"no-store"}).then((function(t){t.ok?t.text().then((function(t){var r,o,a,n,c,s,i,l,u,d,m,g,p,b,v,x,w,M=t.trim(),k=0,I=(M.match(/^r?\d/gm)||[]).length,y=[],O={},_={},E=1,S=1;if(M&&(M=(M=(M=(M=(M=M.replace(/^[ \r\n]*|[ \r\n]*$/g,"")).replace(/@@/g,"\\@\\@")).replace(/~~/g,"\\~\\~")).replace(/%%/g,"\\%\\%")).replace(/\r?\n/g,"@@"),/ ###,,/.test(M)?(M=(M=M.replace(/,(?=[^"]*"(?:[^"]*"[^"]*")*[^"]*$)/g,"~~")).replace(/@@([^"]+?,)/g,"\n$1"),a=","):/ ###\t\t/.test(M)&&(M=(M=M.replace(/\t(?=[^"]*"(?:[^"]*"[^"]*")*[^"]*$)/g,"%%")).replace(/@@([^"]+?\t)/g,"\n$1"),a="\t"),c=(r=M.split("\n")).length,a&&0!==c&&!(r[0].split(a).length<5))){for(var L=0;L<c;++L){o=r[L].split(a);for(var N=0;N<o.length;++N)(","===a||/^(".*?""[^"]*"".*?"|"[^"]+")$/.test(o[N]))&&(o[N]=o[N].replace(/^"|"$/g,""),o[N]=o[N].replace(/""/g,'"')),o[N]=o[N].replace(/%%/g,"\t"),o[N]=o[N].replace(/~~/g,","),o[N]=o[N].replace(/@@/g,"\n"),o[N]=o[N].replace(/\\%\\%/g,"%%"),o[N]=o[N].replace(/\\~\\~/g,"~~"),o[N]=o[N].replace(/\\@\\@/g,"@@");if(o[0]=o[0].toLowerCase(),/^c\d+/.test(o[0]))y.push({k:o[0],n:o[1],s:o[2],h:isNaN(parseInt(o[3]))?o[3]:""}),E=Math.max(E,+o[0].slice(1))+1;else if(/^r\d+/.test(o[0])||!isNaN(parseInt(o[0])))7===o.length&&(_[o[0]]={t:+o[1],n:o[2],v:o[3],s:o[4],o:+o[5],c:o[6]},++S,k=Math.max(+o[0].slice(1),I,k));else if(0===o[0].indexOf("advanced"))s=JSON.parse(o[1]);else if(0===o[0].indexOf("exceptions"))i=JSON.parse(o[1]);else if(0===o[0].indexOf("textclips"))l=JSON.parse(o[1]);else if(0===o[0].indexOf("variables"))u=JSON.parse(o[1]);else if("### autofill options ###"===o[0]&&(n=L),n&&L>n+1&&/^[a-z]+$/.test(o[0]))switch(O[o[0]]=+o[1],o[0]){case"attributesoff":m=o[2].replace(/\|/g,",");break;case"autoimport":g=o[2];break;case"backup":p=+o[2];break;case"closeinfobar":b=+o[2];break;case"delay":v=+o[2];break;case"sitefilters":x=+o[2];break;case"voice":w=+o[2]}}d=e.catnow>y.length+4?2:e.catnow,void 0===O.autoimport&&(O.autoimport=0),h({advanced:s,attributesoff:m||"",autoimport:g||"",backup:p,catcount:E,catnow:d,cats:y,closeinfobar:b,delay:v,exceptions:i,other:O,rulecount:Math.max(S,++k),rules:JSON.stringify(_),sitefilters:x,textclips:l,variables:u,voice:w}),O.menu&&f(y,d)}})):console.error("["+a+"] "+chrome.i18n.getMessage("statusServerError")+(t.status?" ("+t.status+")":""))})).catch((function(e){console.error("["+a+"] "+chrome.i18n.getMessage("statusRequestError")+" ("+e+")")}))}))})),chrome.storage.onChanged.addListener((function(){chrome.tabs.query({url:o},(function(e){for(var t=0;t<e.length;++t)chrome.tabs.sendMessage(e[t].id,{type:"sync"},(function(){chrome.runtime.lastError}))}))}));
